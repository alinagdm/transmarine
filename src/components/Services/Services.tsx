import { useState } from 'react';
import { Link } from 'react-router-dom';
import './Services.css';
import { usePortCalculation } from '../../contexts/PortCalculationContext';

const slides = [
  {
    id: 1,
    title: 'ЭКСПЕДИРОВАНИЕ',
    image: '/images/кессон.JPG',
  },
  {
    id: 2,
    title: <>СУДОХОДНАЯ ЛИНИЯ<br />САНКТ-ПЕТЕРБУРГ /<br />КАЛИНИНГРАД</>,
    image: '/images/semiSubShip.JPG',
  },
  {
    id: 3,
    title: <>ПОРТОВОЕ<br />АГЕНТИРОВАНИЕ</>,
    image: '/images/спг.JPG',
  }
];

export default function Services() {
  const [activeIndex, setActiveIndex] = useState(1);
  const [isAnimating, setIsAnimating] = useState(false);
  const { openForm } = usePortCalculation();

  const handlePrev = () => {
    if (isAnimating) return;
    setIsAnimating(true);
    setActiveIndex((prev) => (prev === 0 ? slides.length - 1 : prev - 1));
    setTimeout(() => setIsAnimating(false), 700);
  };

  const handleNext = () => {
    if (isAnimating) return;
    setIsAnimating(true);
    setActiveIndex((prev) => (prev === slides.length - 1 ? 0 : prev + 1));
    setTimeout(() => setIsAnimating(false), 700);
  };

  const getSlidePosition = (slideIndex: number) => {
    const diff = (slideIndex - activeIndex + slides.length) % slides.length;
    
    if (diff === 0) return 'center';
    if (diff === 1 || diff === -(slides.length - 1)) return 'right';
    if (diff === slides.length - 1 || diff === -1) return 'left';
    return 'hidden';
  };

  return (
    <section className="services">
      <div className="services__container">
        <div className="services__slider">
          <button className="services__arrow services__arrow--left" onClick={handlePrev}>
            <img src="/images/tild6137-6430-4430-b162-333139343535__arrow.svg" alt="Назад" />
          </button>

          <div className="services__slides">
            {slides.map((slide, index) => {
              const position = getSlidePosition(index);
              if (position === 'hidden') return null;
              
              const isCenter = position === 'center';
              
              return (
                <Link
                  key={slide.id}
                  to={`/services/${slide.id}`}
                  className={`services__card services__card--${position}`}
                  onClick={(e) => {
                    // Предотвращаем переход при клике на стрелки
                    const target = e.target as HTMLElement;
                    if (target.closest('.services__arrow')) {
                      e.preventDefault();
                      return;
                    }
                    // Для боковых карточек можно оставить переключение слайда или сразу перейти
                    // Сейчас делаем переход на детальку для всех карточек
                  }}
                >
                  <img src={slide.image} alt="" className="services__card-bg" loading="lazy" />
                  <div className="services__card-overlay" />
                  <div className="services__card-content">
                    <h3 className="services__card-title">{slide.title}</h3>
                    <span 
                      className={`services__card-btn ${isCenter ? 'services__card-btn--blue' : 'services__card-btn--white'}`}
                    >
                      подробнее
                    </span>
                  </div>
                </Link>
              );
            })}
          </div>

          <button className="services__arrow services__arrow--right" onClick={handleNext}>
            <img src="/images/tild3133-3334-4433-a465-356164326434__arrow-left.svg" alt="Вперед" />
          </button>
        </div>

        <div className="services__dots">
          {slides.map((_, index) => (
            <button
              key={index}
              className={`services__dot ${index === activeIndex ? 'services__dot--active' : ''}`}
              onClick={() => {
                if (!isAnimating) {
                  setIsAnimating(true);
                  setActiveIndex(index);
                  setTimeout(() => setIsAnimating(false), 700);
                }
              }}
            />
          ))}
        </div>

        <div className="services__info">
          <Link to="/port-information" className="services__info-card">
            <div className="services__info-icon">
              <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                <path fillRule="evenodd" clipRule="evenodd" d="M20.506225 0.18981225C20.29185 0.30298 20.0821 0.5186275 19.966775 0.744495C19.79295 1.0851225 19.778125 1.2949575 19.778125 3.41495V5.715825H17.522775C15.44755 5.715825 15.237875 5.7309 14.897225 5.90455C14.658825 6.026075 14.459575 6.225225 14.337975 6.46345C14.164225 6.8039 14.149125 7.01345 14.149125 9.087425V11.3414H23.999875H33.8505V9.087425C33.8505 7.01345 33.8355 6.8039 33.66175 6.46345C33.54025 6.225225 33.341 6.026075 33.1025 5.90455C32.76175 5.7309 32.55225 5.715825 30.477 5.715825H28.2215V3.41495C28.2215 1.29402 28.207 1.0852175 28.03275 0.74412C27.91125 0.505875 27.712 0.30673 27.4735 0.185218C27.12375 0.006980975 26.92975 -0.003332575 23.980175 0.0006053325C21.056175 0.004543225 20.8346 0.016544475 20.506225 0.18981225ZM9.24825 14.347525C9.033875 14.460675 8.8241 14.676325 8.7088 14.9022C8.52625 15.2598 8.52015 15.447025 8.52015 20.657075V26.04225L15.298375 23.135425C19.026375 21.536525 22.308825 20.1426 22.592625 20.0377C23.313025 19.771425 24.6867 19.771425 25.407 20.0377C25.691 20.1426 28.97325 21.536525 32.70125 23.135425L39.4795 26.04225V20.657075C39.4795 15.444875 39.4735 15.259975 39.29075 14.901825C39.16925 14.663575 38.97 14.464425 38.7315 14.342925C38.36525 14.15615 38.21225 14.154175 23.980175 14.1583C9.847275 14.162425 9.592925 14.165625 9.24825 14.347525ZM13.11715 27.097C7.93145 29.30975 3.59215 31.17125 3.474325 31.23375C3.200475 31.37875 2.8951 31.8715 2.8298 32.2735C2.7918 32.508 3.231325 34.1125 4.5837 38.6765C5.576275 42.026 6.40965 44.82325 6.435625 44.8925C6.5501 45.19725 5.7108 44.5955 5.161225 43.979C4.091825 42.77925 3.054675 42.26525 1.6651575 42.24625C0.922695 42.236 0.8352575 42.255 0.5190025 42.4955C-0.06500575 42.9395 -0.173833 43.81375 0.282865 44.394C0.5276325 44.705 1.14016 44.99625 1.5553 44.999C2.0369525 45.00225 2.682025 45.35975 3.0619 45.834C4.15645 47.2005 5.308325 47.854 6.829 47.971C8.42125 48.09375 9.640025 47.563 10.884025 46.2045C11.72445 45.2865 12.07045 45.08125 12.78785 45.07475C13.533225 45.06825 14.0525 45.359 14.66475 46.12575C15.22145 46.82325 16.011475 47.40375 16.847675 47.73025C17.2858 47.90125 17.57755 47.941 18.417775 47.944C19.98115 47.94975 20.802125 47.5785 22.006275 46.32175L22.592625 45.70975V34.3855C22.592625 28.15725 22.582025 23.064075 22.569175 23.06745C22.5563 23.0709 18.30285 24.884125 13.11715 27.097ZM25.407 34.337V45.6235L26.228 46.42475C27.14 47.315 27.73875 47.66725 28.6785 47.8665C29.485 48.03725 30.11575 48.03525 30.78925 47.86C31.86525 47.58 32.33775 47.283 33.34 46.25725C33.859 45.726 34.40775 45.244 34.55975 45.18575C34.7115 45.12775 35.05375 45.078 35.32025 45.07525C36.02925 45.068 36.57875 45.369 37.14425 46.07425C38.3915 47.63 40.28375 48.319 42.04725 47.86C43.12025 47.58075 43.5945 47.2815 44.6395 46.22425C45.62875 45.22325 45.9875 45.001 46.61425 45.001C46.734 45.001 47.0155 44.91225 47.24 44.80375C48.25775 44.31125 48.252 42.825 47.2305 42.3405C46.82825 42.14975 46.248 42.14675 45.527 42.33175C44.366 42.62975 43.46 43.22075 42.7185 44.164C42.257 44.751 41.47625 45.27975 41.577 44.93675C43.42525 38.6525 45.11725 32.52675 45.0755 32.26975C44.9965 31.7825 44.67325 31.34875 44.239 31.146C44.02075 31.04425 39.72575 29.1995 34.695 27.04675C29.664 24.893975 25.51625 23.11405 25.4775 23.09145C25.43875 23.06875 25.407 28.12925 25.407 34.337ZM19.030025 31.21975C19.4463 31.432 19.778125 31.972 19.778125 32.43725C19.778125 33.15075 19.084725 33.84375 18.370875 33.84375C17.90535 33.84375 17.364875 33.512 17.152475 33.096C16.91335 32.6275 16.91325 32.24725 17.1523 31.779C17.49905 31.09975 18.317025 30.85625 19.030025 31.21975ZM30.288 31.21975C30.70425 31.432 31.036 31.972 31.036 32.43725C31.036 32.59625 30.951 32.8925 30.84725 33.096C30.63475 33.512 30.09425 33.84375 29.62875 33.84375C29.16325 33.84375 28.62275 33.512 28.4105 33.096C28.17125 32.6275 28.17125 32.24725 28.41025 31.779C28.757 31.09975 29.575 30.85625 30.288 31.21975Z" fill="#072168" fillOpacity="0.6"/>
              </svg>
            </div>
            <div className="services__info-text">
              <p>Информация<br />о Калининградском порте</p>
            </div>
            <img 
              src="/images/tild3237-3139-4530-b465-626661383234__vector_2.svg" 
              alt="" 
              className="services__info-arrow" 
            />
          </Link>

          <button 
            className="services__info-card services__info-card--blue"
            onClick={openForm}
          >
            <div className="services__info-icon">
              <svg width="54" height="54" viewBox="0 0 54 54" fill="none">
                <path fillRule="evenodd" clipRule="evenodd" d="M21.5 43C11.3649 43 6.29735 43 3.1476 39.85025C0 36.70475 0 31.635 0 21.5C0 11.3649 0 6.29735 3.1476 3.1476C6.2995 0 11.3649 0 21.5 0C31.635 0 36.70275 0 39.85025 3.1476C43 6.2995 43 11.3649 43 21.5C43 31.635 43 36.70275 39.85025 39.85025C36.70475 43 31.635 43 21.5 43ZM14.5125 9.675C14.5125 9.24735 14.3426 8.8372 14.0402 8.5348C13.7378 8.2324 13.32765 8.0625 12.9 8.0625C12.47235 8.0625 12.0622 8.2324 11.7598 8.5348C11.457375 8.8372 11.2875 9.24735 11.2875 9.675V12.3625H8.6C8.17235 12.3625 7.7622 12.5324 7.4598 12.8348C7.157375 13.1372 6.9875 13.54735 6.9875 13.975C6.9875 14.40265 7.157375 14.8128 7.4598 15.1152C7.7622 15.4176 8.17235 15.5875 8.6 15.5875H11.2875V18.275C11.2875 18.70265 11.457375 19.1128 11.7598 19.4152C12.0622 19.7176 12.47235 19.8875 12.9 19.8875C13.32765 19.8875 13.7378 19.7176 14.0402 19.4152C14.3426 19.1128 14.5125 18.70265 14.5125 18.275V15.5875H17.2C17.62765 15.5875 18.0378 15.4176 18.3402 15.1152C18.6426 14.8128 18.8125 14.40265 18.8125 13.975C18.8125 13.54735 18.6426 13.1372 18.3402 12.8348C18.0378 12.5324 17.62765 12.3625 17.2 12.3625H14.5125V9.675ZM25.8 12.3625C25.37225 12.3625 24.9622 12.5324 24.6598 12.8348C24.3574 13.1372 24.1875 13.54735 24.1875 13.975C24.1875 14.40265 24.3574 14.8128 24.6598 15.1152C24.9622 15.4176 25.37225 15.5875 25.8 15.5875H34.4C34.82775 15.5875 35.23775 15.4176 35.54025 15.1152C35.8425 14.8128 36.0125 14.40265 36.0125 13.975C36.0125 13.54735 35.8425 13.1372 35.54025 12.8348C35.23775 12.5324 34.82775 12.3625 34.4 12.3625H25.8ZM25.8 25.2625C25.37225 25.2625 24.9622 25.4325 24.6598 25.73475C24.3574 26.03725 24.1875 26.44725 24.1875 26.875C24.1875 27.30275 24.3574 27.71275 24.6598 28.01525C24.9622 28.3175 25.37225 28.4875 25.8 28.4875H34.4C34.82775 28.4875 35.23775 28.3175 35.54025 28.01525C35.8425 27.71275 36.0125 27.30275 36.0125 26.875C36.0125 26.44725 35.8425 26.03725 35.54025 25.73475C35.23775 25.4325 34.82775 25.2625 34.4 25.2625H25.8ZM10.8145 25.7355C10.508825 25.45075 10.104525 25.2955 9.686775 25.303C9.269025 25.31025 8.87045 25.4795 8.575 25.775C8.279575 26.0705 8.11035 26.469 8.102975 26.88675C8.0956 27.3045 8.250675 27.70875 8.5355 28.0145L10.621 30.1L8.5355 32.1855C8.377075 32.333 8.25 32.51125 8.161875 32.709C8.073725 32.90675 8.02635 33.12025 8.022525 33.33675C8.0187 33.55325 8.058525 33.76825 8.139625 33.96925C8.220725 34.17 8.34145 34.35225 8.494575 34.5055C8.647675 34.6585 8.830075 34.77925 9.030875 34.86025C9.23165 34.9415 9.4467 34.98125 9.663225 34.9775C9.879725 34.97375 10.09325 34.92625 10.29105 34.83825C10.48885 34.75 10.666875 34.623 10.8145 34.4645L12.9 32.379L14.9855 34.4645C15.133125 34.623 15.31115 34.75 15.50895 34.83825C15.70675 34.92625 15.920275 34.97375 16.136775 34.9775C16.353275 34.98125 16.56835 34.9415 16.769125 34.86025C16.969925 34.77925 17.1523 34.6585 17.305425 34.5055C17.45855 34.35225 17.579275 34.17 17.660375 33.96925C17.741475 33.76825 17.7813 33.55325 17.777475 33.33675C17.77365 33.12025 17.72625 32.90675 17.638125 32.709C17.55 32.51125 17.422925 32.333 17.2645 32.1855L15.179 30.1L17.2645 28.0145C17.422925 27.867 17.55 27.68875 17.638125 27.491C17.72625 27.29325 17.77365 27.07975 17.777475 26.86325C17.7813 26.64675 17.741475 26.43175 17.660375 26.23075C17.579275 26.03 17.45855 25.84775 17.305425 25.6945C17.1523 25.5415 16.969925 25.42075 16.769125 25.33975C16.56835 25.2585 16.353275 25.21875 16.136775 25.2225C15.920275 25.22625 15.70675 25.27375 15.50895 25.36175C15.31115 25.45 15.133125 25.577 14.9855 25.7355L12.9 27.821L10.8145 25.7355ZM25.8 31.7125C25.37225 31.7125 24.9622 31.8825 24.6598 32.18475C24.3574 32.48725 24.1875 32.89725 24.1875 33.325C24.1875 33.75275 24.3574 34.16275 24.6598 34.46525C24.9622 34.7675 25.37225 34.9375 25.8 34.9375H34.4C34.82775 34.9375 35.23775 34.7675 35.54025 34.46525C35.8425 34.16275 36.0125 33.75275 36.0125 33.325C36.0125 32.89725 35.8425 32.48725 35.54025 32.18475C35.23775 31.8825 34.82775 31.7125 34.4 31.7125H25.8Z" fill="#136BDF"/>
              </svg>
            </div>
            <div className="services__info-text services__info-text--blue">
              <p>Расчет<br />портовых сборов</p>
            </div>
            <img 
              src="/images/tild3931-3333-4738-a136-646236393230__vector_2_1.svg" 
              alt="" 
              className="services__info-arrow" 
            />
          </button>
        </div>
      </div>
    </section>
  );
}
